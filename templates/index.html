<!DOCTYPE html>
<html>
<head>
    <title>Me XP Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-white">
    <div class="container mt-4 p-4 rounded border border-light" style="background-color: #1e1e1e;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-1">üéÆ Me XP Dashboard</h1>
                <blockquote class="blockquote text-warning mb-0">
                    <p class="mb-0"><em>{{ quote }}</em></p>
                </blockquote>
            </div>
            <div class="text-end">
                <a href="{{ url_for('index') }}" class="btn btn-light mb-2">üìä Stats</a><br>
                <a href="{{ url_for('reset') }}" class="btn btn-danger">Reset XP</a>
            </div>
        </div>

        <div class="accordion" id="specializationAccordion">
            {% for spec in specs %}
            {% set spec_index = loop.index %}
            <div class="accordion-item bg-secondary text-white">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                    <button class="accordion-button collapsed bg-dark text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}"
                            aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                        <span id="level-label-{{ loop.index }}">
                            {{ spec.name }} ‚Äî ‚≠ê Level {{ spec.progress.level }}
                        </span>
                    </button>
                </h2>
                <div class="progress mb-3" style="height: 24px;">
                    <div class="progress-bar" id="xp-bar-{{ spec_index }}"
                        role="progressbar"
                        style="width: {{ (spec.progress.xp % 100) }}%;"
                        aria-valuenow="{{ spec.progress.xp % 100 }}" aria-valuemin="0" aria-valuemax="100">
                        <span id="xp-label-{{ spec_index }}">{{ spec.progress.xp % 100 }} / 100 XP</span>
                    </div>
                </div>
                <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
                    aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#specializationAccordion">
                    <div class="accordion-body">

                        {% for tier in spec.get_goals() %}
                        {% if spec.progress.level >= tier.level_range[0] %}
                        <div class="card bg-secondary text-white mb-2">
                            <div class="card-header">
                                üß± Tier {{ tier.tier }} (Lv {{ tier.level_range[0] }}‚Äì{{ tier.level_range[1] }})
                            </div>
                            <ul class="list-group list-group-flush">
                                {% for goal in tier.goals %}
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center"
                                    data-goal="{{ goal.name }}">
                                    <div class="goal-info" id="goal-info-{{ spec_index }}-{{ loop.index0 }}">
                                        <strong>{{ goal.name }}</strong><br>
                                        {% set multiplier = 1.0 + 0.1 * (goal.streak.current if goal.streak.current < 10 else 10) %}
                                        {% set adjusted_xp = (goal.xp * multiplier)|round(0, 'floor') %}
                                        <small>
                                            ‚ú® {{ goal.xp|int }} XP ‚Üí
                                            üí• <span class="goal-adjusted-xp">{{ adjusted_xp|int }}</span> XP |
                                            üî• Streak: <span class="goal-streak">{{ goal.streak.current }}</span>
                                            (Best: <span class="goal-streak-best">{{ goal.streak.best }}</span>) |
                                            üí• XP Multiplier: x<span class="goal-multiplier">{{ multiplier|round(1) }}</span>
                                        </small>
                                    </div>
                                    {% if current_date in goal.completed %}
                                        <span class="badge bg-success">‚úî Done</span>
                                    {% else %}
                                        <button class="btn btn-light btn-sm complete-goal"
                                                data-spec="{{ spec.name }}"
                                                data-goal="{{ goal.name }}"
                                                data-base-xp="{{ goal.xp }}"
                                                data-xp-bar-id="xp-bar-{{ spec_index }}"
                                                data-level-label-id="level-label-{{ spec_index }}"
                                                data-xp-label-id="xp-label-{{ spec_index }}">
                                            Complete
                                        </button>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.querySelectorAll('.complete-goal').forEach(button => {
    button.addEventListener('click', () => {
        const spec = button.dataset.spec;
        const goal = button.dataset.goal;
        const xpBar = document.getElementById(button.dataset.xpBarId);
        const levelLabel = document.getElementById(button.dataset.levelLabelId);
        const xpLabel = document.getElementById(button.dataset.xpLabelId);

        fetch(`/complete_goal/${encodeURIComponent(spec)}/${encodeURIComponent(goal)}`, {
            method: 'POST'
        }).then(res => res.json()).then(data => {
            // Update button
            button.classList.remove('btn-light');
            button.classList.add('btn-success');
            button.textContent = `‚úî +${data.awarded} XP`;
            button.disabled = true;

            // Update level + XP bar
            if (xpBar && xpLabel && levelLabel) {
                xpBar.style.width = data.current + '%';
                xpBar.setAttribute('aria-valuenow', data.current);
                xpLabel.textContent = `${data.current} / 100 XP`;
                levelLabel.textContent = `${spec} ‚Äî ‚≠ê Level ${data.level}`;
            }

            // Update goal info (streak, multiplier)
            const goalRow = button.closest('li');
            if (goalRow) {
                goalRow.querySelector('.goal-streak').textContent = data.streak.current;
                goalRow.querySelector('.goal-streak-best').textContent = data.streak.best;
                goalRow.querySelector('.goal-multiplier').textContent = data.multiplier.toFixed(1);

                // Optionally add ‚úî badge next to goal
                const badge = document.createElement('span');
                badge.className = 'badge bg-success ms-2';
                badge.textContent = '‚úî Done';
                button.replaceWith(badge);
            }

            // Multiply next viewed xp gain
            const adjustedXp = Math.floor(button.dataset.baseXp * data.multiplier);
            goalRow.querySelector('.goal-adjusted-xp').textContent = adjustedXp;
        });
    });
});
</script>
